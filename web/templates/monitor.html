<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matriz Orders</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #30363d;
            background: #161b22;
        }
        .header h1 { color: #58a6ff; font-size: 1.3em; }
        .connection-status { display: flex; align-items: center; gap: 8px; }
        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.connected { background: #3fb950; }
        .status-dot.disconnected { background: #f85149; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Tabs */
        .tabs { display: flex; background: #161b22; border-bottom: 1px solid #30363d; }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #8b949e;
            transition: all 0.2s;
        }
        .tab:hover { color: #c9d1d9; }
        .tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        /* Grid and Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }
        .card-title {
            color: #8b949e;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title::before {
            content: '';
            width: 4px; height: 16px;
            background: #58a6ff;
            border-radius: 2px;
        }

        /* WebSocket Status */
        .ws-status {
            font-size: 1.2em;
            padding: 15px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .ws-status.running { background: rgba(63, 185, 80, 0.15); color: #3fb950; border: 1px solid rgba(63, 185, 80, 0.3); }
        .ws-status.disconnected { background: rgba(248, 81, 73, 0.15); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.3); }
        .ws-status.initialized, .ws-status.waiting { background: rgba(110, 118, 129, 0.15); color: #8b949e; border: 1px solid rgba(110, 118, 129, 0.3); }
        .ws-status.paper { background: rgba(210, 153, 34, 0.15); color: #d29922; border: 1px solid rgba(210, 153, 34, 0.3); }
        .ws-status.failed { background: rgba(248, 81, 73, 0.25); color: #f85149; border: 1px solid rgba(248, 81, 73, 0.5); }

        /* Mode badge */
        .mode-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        .mode-badge.prod { background: #238636; color: white; }
        .mode-badge.paper { background: #d29922; color: white; }

        /* Stats */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: #8b949e; }
        .stat-value { color: #c9d1d9; font-weight: bold; }

        /* Messages */
        .messages-container { max-height: 300px; overflow-y: auto; font-size: 0.8em; }
        .message-item {
            padding: 6px 10px;
            border-bottom: 1px solid #21262d;
            display: flex;
            gap: 10px;
        }
        .message-item:nth-child(odd) { background: rgba(255,255,255,0.02); }
        .message-time { color: #6e7681; min-width: 80px; }
        .message-type { padding: 2px 6px; border-radius: 3px; font-size: 0.85em; min-width: 20px; text-align: center; }
        .message-type.O { background: #da3633; color: white; }
        .message-content { color: #8b949e; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

        /* Control Panel */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .btn-primary { background: #238636; color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: #30363d; color: #c9d1d9; }
        .btn-secondary:hover { background: #484f58; }
        .btn-danger { background: #da3633; color: white; }
        .btn-danger:hover { background: #f85149; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Config form */
        .config-field { margin-bottom: 15px; }
        .config-field label { display: block; color: #8b949e; margin-bottom: 5px; font-size: 0.9em; }
        .config-field input, .config-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #0d1117;
            color: #c9d1d9;
            font-family: inherit;
        }
        .config-field input:focus { outline: none; border-color: #58a6ff; }

        .no-events { color: #6e7681; font-style: italic; text-align: center; padding: 20px; }

        /* Footer */
        .footer {
            padding: 15px 20px;
            border-top: 1px solid #30363d;
            font-size: 0.8em;
            color: #6e7681;
            display: flex;
            justify-content: space-between;
            background: #161b22;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>MATRIZ ORDERS <span id="app-mode-badge" class="mode-badge paper">PAPER</span></h1>
        <div class="connection-status">
            <span id="ui-ws-status">Conectando...</span>
            <div id="ui-ws-dot" class="status-dot disconnected"></div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="orders">Ordenes</div>
        <div class="tab" data-tab="config">Configuracion</div>
    </div>

    <!-- Tab: Ordenes -->
    <div id="tab-orders" class="tab-content active">
        <!-- Order Listener Status Banner -->
        <div style="margin-bottom: 20px;">
            <div class="card" style="padding: 10px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="color: #8b949e; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px;">Order Listener</span>
                        <span id="order-status" class="ws-status initialized" style="font-size: 0.9em; padding: 5px 15px; margin: 0;">INICIALIZANDO</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; font-size: 0.85em; color: #8b949e;">
                        <span>Mensajes: <strong id="order-msg-count" style="color: #c9d1d9;">0</strong></span>
                        <span>Ultimo: <strong id="order-last-msg-time" style="color: #c9d1d9;">-</strong></span>
                        <span>Uptime: <strong id="order-uptime" style="color: #c9d1d9;">-</strong></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid" style="grid-template-columns: 1fr;">
            <!-- Formulario para nueva orden -->
            <div class="card">
                <div class="card-title">Nueva Orden <span id="order-mode-indicator" class="mode-badge paper">PAPER</span></div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 15px;">
                    <div class="config-field">
                        <label>Ticker</label>
                        <select id="order-ticker">
                            <option value="AL30">AL30</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>Plazo</label>
                        <select id="order-term">
                            <option value="CI">CI</option>
                            <option value="24hs">24hs</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>Tipo</label>
                        <select id="order-type" onchange="togglePriceFields()">
                            <option value="1">MARKET</option>
                            <option value="2">LIMIT</option>
                        </select>
                    </div>
                    <div class="config-field">
                        <label>Side</label>
                        <select id="order-side">
                            <option value="1">COMPRA</option>
                            <option value="2">VENTA</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="config-field">
                        <label>Cantidad</label>
                        <input type="number" id="order-quantity" min="1" value="1">
                    </div>
                    <div class="config-field" id="price-source-field" style="display: none;">
                        <label>Precio del Book</label>
                        <select id="order-price-source" onchange="toggleManualPrice()">
                            <option value="manual">Manual</option>
                            <option value="bid1">Bid 1</option>
                            <option value="bid2">Bid 2</option>
                            <option value="bid3">Bid 3</option>
                            <option value="offer1">Offer 1</option>
                            <option value="offer2">Offer 2</option>
                            <option value="offer3">Offer 3</option>
                        </select>
                    </div>
                    <div class="config-field" id="price-field" style="display: none;">
                        <label>Precio Limite</label>
                        <input type="number" id="order-price" min="0" step="0.01">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="placeOrder()">Colocar Orden</button>
                    <span id="order-form-status" style="color: #8b949e; font-size: 0.85em; margin-left: 15px;"></span>
                </div>
            </div>

            <!-- Busqueda de mensajes de orden -->
            <div class="card">
                <div class="card-title">Mensajes de Estado de Ordenes</div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="order-search-id" placeholder="ID de orden" style="flex: 1; padding: 10px; border: 1px solid #30363d; border-radius: 6px; background: #0d1117; color: #c9d1d9; font-family: inherit;">
                    <button class="btn btn-primary" onclick="searchOrderMessages()">Listar</button>
                </div>
                <div id="order-messages" class="messages-container" style="max-height: 200px;">
                    <div class="no-events">Ingrese un ID de orden y presione Listar</div>
                </div>
            </div>

            <!-- Filtros de ordenes -->
            <div class="card">
                <div class="card-title">Filtros de Ordenes</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="filter-filled" checked onchange="refreshOrders()">
                        <span>Filled</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="filter-partial" checked onchange="refreshOrders()">
                        <span>Partial</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="filter-placed" checked onchange="refreshOrders()">
                        <span>Placed/Confirmed</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="filter-canceled-partial" checked onchange="refreshOrders()">
                        <span>Canceled (con ejecucion)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="filter-canceled-empty" onchange="refreshOrders()">
                        <span>Canceled (sin ejecucion)</span>
                    </label>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-secondary" onclick="refreshOrders()">Actualizar Lista</button>
                </div>
            </div>

            <!-- Lista de ordenes -->
            <div class="card">
                <div class="card-title">
                    <span>Ordenes del Dia</span>
                    <span id="orders-count" style="margin-left: 10px; font-weight: normal;">(0)</span>
                </div>
                <div id="orders-list" style="max-height: 500px; overflow-y: auto;">
                    <div class="no-events">Cargando ordenes...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Configuracion -->
    <div id="tab-config" class="tab-content">
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-title">Informacion del Sistema</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div class="stat-row" style="border: none;">
                    <span class="stat-label">Matriz Host</span>
                    <span class="stat-value" id="config-matriz-host">-</span>
                </div>
                <div class="stat-row" style="border: none;">
                    <span class="stat-label">Puerto del Monitor</span>
                    <span class="stat-value">8000</span>
                </div>
                <div class="stat-row" style="border: none;">
                    <span class="stat-label">Logs Directory</span>
                    <span class="stat-value">logs/ws</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Configuracion de Sesion</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 15px;">
                <div class="stat-row" style="border: none;">
                    <span class="stat-label">Account ID</span>
                    <span class="stat-value" id="session-account-id">-</span>
                </div>
                <div class="config-field">
                    <label>Dias de Caucion</label>
                    <input type="number" id="session-min-caucion-days" min="1" value="1">
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn btn-primary" onclick="updateSessionConfig()">Actualizar Dias de Caucion</button>
                <span id="session-config-status" style="color: #8b949e; font-size: 0.85em;"></span>
            </div>
        </div>
    </div>

    <div class="footer">
        <span>Matriz Orders v2.0</span>
        <span id="last-update">Ultima actualizacion: -</span>
    </div>

    <script>
        let ws;
        let reconnectAttempts = 0;
        let appMode = 'paper';

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                document.getElementById('ui-ws-status').textContent = 'Conectado';
                document.getElementById('ui-ws-dot').classList.remove('disconnected');
                document.getElementById('ui-ws-dot').classList.add('connected');
                reconnectAttempts = 0;
            };

            ws.onclose = () => {
                document.getElementById('ui-ws-status').textContent = 'Desconectado';
                document.getElementById('ui-ws-dot').classList.remove('connected');
                document.getElementById('ui-ws-dot').classList.add('disconnected');
                setTimeout(() => { reconnectAttempts++; connectWebSocket(); }, Math.min(1000 * reconnectAttempts, 5000));
            };

            ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
        }

        function handleMessage(msg) {
            document.getElementById('last-update').textContent = `Ultima actualizacion: ${new Date().toLocaleTimeString()}`;

            if (msg.type === 'initial_state') {
                updateOrderProcessor(msg.data.order_processor);
                if (msg.data.mode) updateMode(msg.data.mode);
            } else if (msg.type === 'state_update') {
                if (msg.data.order_listener) updateOrderStatus(msg.data.order_listener);
                if (msg.data.order_message) updateOrderMessage(msg.data.order_message);
                if (msg.data.mode !== undefined) updateMode(msg.data.mode);
            }
        }

        function updateMode(mode) {
            appMode = mode;

            // Header badge
            const badge = document.getElementById('app-mode-badge');
            badge.textContent = mode.toUpperCase();
            badge.className = 'mode-badge ' + mode;

            // Order form badge
            const orderModeIndicator = document.getElementById('order-mode-indicator');
            if (orderModeIndicator) {
                orderModeIndicator.textContent = mode.toUpperCase();
                orderModeIndicator.className = 'mode-badge ' + mode;
            }
        }

        function updateOrderStatus(orderData) {
            const statusEl = document.getElementById('order-status');
            const status = orderData.status || 'Disconnected';
            statusEl.textContent = status.toUpperCase();
            statusEl.className = 'ws-status ' + status.toLowerCase();
            if (orderData.message_count !== undefined) document.getElementById('order-msg-count').textContent = orderData.message_count;
        }

        function updateOrderProcessor(proc) {
            if (!proc) return;
            document.getElementById('order-msg-count').textContent = proc.message_count || 0;
            if (proc.last_message_time) document.getElementById('order-last-msg-time').textContent = new Date(proc.last_message_time).toLocaleTimeString();
            if (proc.uptime_seconds) {
                const mins = Math.floor(proc.uptime_seconds / 60);
                const secs = Math.floor(proc.uptime_seconds % 60);
                document.getElementById('order-uptime').textContent = `${mins}m ${secs}s`;
            }
            if (proc.status) updateOrderStatus({status: proc.status});
        }

        function updateOrderMessage(msg) {
            if (msg.count !== undefined) document.getElementById('order-msg-count').textContent = msg.count;
            if (msg.timestamp) document.getElementById('order-last-msg-time').textContent = new Date(msg.timestamp).toLocaleTimeString();
        }

        // Uptime counter
        setInterval(() => {
            const orderUptimeEl = document.getElementById('order-uptime');
            const orderText = orderUptimeEl.textContent;
            if (orderText && orderText !== '-') {
                const match = orderText.match(/(\d+)m (\d+)s/);
                if (match) {
                    let mins = parseInt(match[1]);
                    let secs = parseInt(match[2]) + 1;
                    if (secs >= 60) { secs = 0; mins++; }
                    orderUptimeEl.textContent = `${mins}m ${secs}s`;
                }
            }
        }, 1000);

        // ===== ORDER MESSAGES SEARCH =====

        async function searchOrderMessages() {
            const orderId = document.getElementById('order-search-id').value.trim();
            const container = document.getElementById('order-messages');

            if (!orderId) {
                container.innerHTML = '<div class="no-events">Ingrese un ID de orden</div>';
                return;
            }

            container.innerHTML = '<div class="no-events">Buscando...</div>';

            try {
                const resp = await fetch(`/api/orders/messages/${encodeURIComponent(orderId)}`);
                const data = await resp.json();

                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = data.messages.map(msg => `
                        <div class="message-item">
                            <span class="message-time">${msg.timestamp}</span>
                            <span class="message-type O">O</span>
                            <span class="message-content" title="${msg.content}">${msg.content}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `<div class="no-events">No se encontraron mensajes para orden ${orderId}</div>`;
                }
            } catch (e) {
                container.innerHTML = '<div class="no-events" style="color: #f85149;">Error al buscar mensajes</div>';
            }
        }

        // ===== ORDERS TAB FUNCTIONS =====

        function togglePriceFields() {
            const orderType = document.getElementById('order-type').value;
            const priceSourceField = document.getElementById('price-source-field');
            const priceField = document.getElementById('price-field');

            if (orderType === '1') {
                priceSourceField.style.display = 'none';
                priceField.style.display = 'none';
            } else {
                priceSourceField.style.display = 'block';
                toggleManualPrice();
            }
        }

        function toggleManualPrice() {
            const priceSource = document.getElementById('order-price-source').value;
            const priceField = document.getElementById('price-field');
            priceField.style.display = priceSource === 'manual' ? 'block' : 'none';
        }

        async function placeOrder() {
            const ticker = document.getElementById('order-ticker').value;
            const term = document.getElementById('order-term').value;
            const side = document.getElementById('order-side').value;
            const orderType = document.getElementById('order-type').value;
            const quantity = parseInt(document.getElementById('order-quantity').value);
            const status = document.getElementById('order-form-status');

            if (!quantity || quantity <= 0) {
                status.textContent = 'Error: Cantidad invalida';
                status.style.color = '#f85149';
                return;
            }

            const request = { ticker, term, side, order_type: orderType, quantity };

            if (orderType === '2') {
                const priceSource = document.getElementById('order-price-source').value;
                if (priceSource === 'manual') {
                    const price = parseFloat(document.getElementById('order-price').value);
                    if (!price || price <= 0) {
                        status.textContent = 'Error: Precio invalido';
                        status.style.color = '#f85149';
                        return;
                    }
                    request.price = price;
                    request.price_source = 'manual';
                } else {
                    request.price_source = priceSource;
                }
            }

            status.textContent = 'Enviando orden...';
            status.style.color = '#8b949e';

            try {
                const resp = await fetch('/api/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(request)
                });
                const data = await resp.json();

                if (data.error) {
                    status.textContent = `Error: ${data.error}`;
                    status.style.color = '#f85149';
                } else if (data.success) {
                    status.textContent = data.message || 'Orden colocada exitosamente';
                    status.style.color = '#3fb950';
                    setTimeout(() => refreshOrders(), 500);
                }
            } catch (e) {
                status.textContent = `Error: ${e.message}`;
                status.style.color = '#f85149';
            }
        }

        async function refreshOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '<div class="no-events">Cargando...</div>';

            try {
                const resp = await fetch('/api/orders');
                const data = await resp.json();

                if (!data.orders || data.orders.length === 0) {
                    container.innerHTML = '<div class="no-events">No hay ordenes del dia</div>';
                    document.getElementById('orders-count').textContent = '(0)';
                    return;
                }

                const showFilled = document.getElementById('filter-filled').checked;
                const showPartial = document.getElementById('filter-partial').checked;
                const showPlaced = document.getElementById('filter-placed').checked;
                const showCanceledPartial = document.getElementById('filter-canceled-partial').checked;
                const showCanceledEmpty = document.getElementById('filter-canceled-empty').checked;

                const filteredOrders = data.orders.filter(order => {
                    if (order.status === 'filled') return showFilled;
                    if (order.status === 'partial') return showPartial;
                    if (order.status === 'placed' || order.status === 'confirmed') return showPlaced;
                    if (order.status === 'canceled' || order.status === 'confirmed_canceled') {
                        return order.operated_size > 0 ? showCanceledPartial : showCanceledEmpty;
                    }
                    return true;
                });

                document.getElementById('orders-count').textContent = `(${filteredOrders.length})`;

                if (filteredOrders.length === 0) {
                    container.innerHTML = '<div class="no-events">No hay ordenes que cumplan los filtros</div>';
                    return;
                }

                container.innerHTML = filteredOrders.map(order => renderOrder(order)).join('');

            } catch (e) {
                container.innerHTML = `<div class="no-events" style="color: #f85149;">Error: ${e.message}</div>`;
            }
        }

        function renderOrder(order) {
            const sideColor = order.side === '1' ? '#3fb950' : '#f85149';
            const sideText = order.side_text;
            const statusColor = getStatusColor(order.status);
            const avgPrice = order.price ? order.price.toFixed(2) : '-';
            const opVolume = order.operated_volume ? order.operated_volume.toFixed(2) : '0';

            return `
                <div style="padding: 15px; border-bottom: 1px solid #21262d; font-size: 0.9em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <div>
                            <span style="color: #58a6ff; font-weight: bold;">#${order.id}</span>
                            <span style="color: ${sideColor}; font-weight: bold; margin-left: 10px;">${sideText}</span>
                            <span style="color: #8b949e; margin-left: 10px;">${order.instrument}</span>
                            <span style="color: #8b949e; margin-left: 10px;">${order.order_type_text}</span>
                        </div>
                        <div>
                            <span style="background: ${statusColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em;">
                                ${order.status.toUpperCase()}
                            </span>
                            <span class="mode-badge ${order.mode}">${order.mode.toUpperCase()}</span>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.85em;">
                        <div>
                            <span style="color: #6e7681;">Cantidad:</span>
                            <span style="color: #c9d1d9; font-weight: bold;">${order.operated_size}/${order.quantity}</span>
                        </div>
                        <div>
                            <span style="color: #6e7681;">Precio Prom:</span>
                            <span style="color: #c9d1d9; font-weight: bold;">$${avgPrice}</span>
                        </div>
                        <div>
                            <span style="color: #6e7681;">Volumen Op:</span>
                            <span style="color: #c9d1d9; font-weight: bold;">$${opVolume}</span>
                        </div>
                        <div>
                            <span style="color: #6e7681;">Placed:</span>
                            <span style="color: #c9d1d9;">${order.placed ? new Date(order.placed).toLocaleTimeString() : '-'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'filled': return '#238636';
                case 'partial': return '#d29922';
                case 'placed':
                case 'confirmed': return '#1f6feb';
                case 'canceled':
                case 'confirmed_canceled': return '#da3633';
                default: return '#6e7681';
            }
        }

        // ===== SESSION CONFIG FUNCTIONS =====

        async function loadSessionConfig() {
            try {
                const resp = await fetch('/api/session/config');
                const data = await resp.json();

                if (data.error) {
                    console.error('Error loading session config:', data.error);
                    return;
                }

                document.getElementById('session-account-id').textContent = data.account_id || '-';
                if (data.min_caucion_days !== null) {
                    document.getElementById('session-min-caucion-days').value = data.min_caucion_days;
                }
            } catch (e) {
                console.error('Error loading session config:', e);
            }
        }

        async function updateSessionConfig() {
            const minCaucionDays = parseInt(document.getElementById('session-min-caucion-days').value);
            const statusEl = document.getElementById('session-config-status');

            if (!minCaucionDays || minCaucionDays < 1) {
                statusEl.textContent = 'Error: Dias de caucion debe ser >= 1';
                statusEl.style.color = '#f85149';
                return;
            }

            statusEl.textContent = 'Actualizando...';
            statusEl.style.color = '#8b949e';

            try {
                const resp = await fetch('/api/session/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ min_caucion_days: minCaucionDays })
                });
                const data = await resp.json();

                if (data.error) {
                    statusEl.textContent = `Error: ${data.error}`;
                    statusEl.style.color = '#f85149';
                } else if (data.success) {
                    statusEl.textContent = data.message || 'Configuracion actualizada';
                    statusEl.style.color = '#3fb950';
                    if (data.config) {
                        document.getElementById('session-account-id').textContent = data.config.account_id || '-';
                        if (data.config.min_caucion_days !== null) {
                            document.getElementById('session-min-caucion-days').value = data.config.min_caucion_days;
                        }
                    }
                }
            } catch (e) {
                statusEl.textContent = `Error: ${e.message}`;
                statusEl.style.color = '#f85149';
            }
        }

        // Load orders on page load and when tab is clicked
        document.querySelector('[data-tab="orders"]').addEventListener('click', () => {
            refreshOrders();
        });

        document.querySelector('[data-tab="config"]').addEventListener('click', () => {
            loadSessionConfig();
        });

        // Initial load
        connectWebSocket();
        refreshOrders();
    </script>
</body>
</html>
